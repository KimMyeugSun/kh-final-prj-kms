name: team119.jar_CICD_setup

on:
  push:
    branches:
      - release

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° S3 ë°°í¬
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      # ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ Runnerì— ë³µì‚¬
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Node.js ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'front/package-lock.json'

      # í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install Dependencies
        run: |
          cd front
          npm ci

      # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      - name: Build Frontend
        run: |
          cd front
          npm run build
      
      # AWS ìê²© ì¦ëª… êµ¬ì„±
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          aws-region: ap-northeast-2

      #ë¹Œë“œ íŒŒì¼ s3 ë°°í¬ (ë³€ê²½ëœ íŒŒì¼ë§Œ, ì‚­ì œëœ íŒŒì¼ s3ì—ì„œ ì œì™¸)
      - name: Deploy to S3
        run: |
          aws s3 sync front/dist/ s3://${{ secrets.S3_BUCKET_NAME }} --region ap-northeast-2 --delete

      #ìºì‹œ ë¬´íš¨í™”
      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

  # ë°±ì—”ë“œ ë¹Œë“œ ë° Docker ì´ë¯¸ì§€ ìƒì„±/í‘¸ì‹œ
  build-backend:  
    runs-on: ubuntu-latest
    steps:
      # ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ Runnerì— ë³µì‚¬
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Set up JDK for Gradle
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17' 
          distribution: 'zulu'

      # - name: Cache Gradle Dependencies
      #   uses: actions/cache@v3
      #   with:
      #     path: ~/.gradle/caches
      #     key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
      #     restore-keys: |
      #       ${{ runner.os }}-gradle-


      # Build the jar using Gradle bootJar
      - name: Build with bootJar
        run: |
          cd team119
          chmod +x ./gradlew
          ./gradlew clean bootJar
          echo "=== Build Success ==="
          ls -la build/libs/

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_ID }}
          password: ${{ secrets.DOCKER_HUB_PWD }}

      - name: Build Docker Image with Dockerfile
        run: |
          docker build -t ${{ secrets.DOCKER_HUB_ID }}/team119app:latest ./team119
      
      - name: Push Docker Image
        run: |
          docker push ${{ secrets.DOCKER_HUB_ID }}/team119app:latest

  # ë°°í¬ (í™˜ê²½ë³€ìˆ˜ ì£¼ì… ë°©ì‹)
  deploy:
    needs: [build-frontend, build-backend]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_IP }}
          key: ${{ secrets.EC2_KEY }}
          username: ubuntu
          port: 22
          command_timeout: 10m
          script: |
            #!/bin/bash
            set -e
            
            echo "=== Starting deployment process ==="
            
            # í¬íŠ¸ 8080 ì‚¬ìš© í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
            sudo lsof -ti:8080 | xargs -r sudo kill -9 || echo "No processes using port 8080"
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì™„ì „ ì •ë¦¬
            sudo docker stop team119_was 2>/dev/null || echo "No container to stop"
            sudo docker rm team119_was 2>/dev/null || echo "No container to remove"
            sudo docker rmi devyoon2199/team119app:latest 2>/dev/null || echo "No image to remove"
            
            # Docker ì‹œìŠ¤í…œ ì •ë¦¬
            sudo docker system prune -f
            
            # ìµœì‹  ì´ë¯¸ì§€ pull
            echo "=== Pulling latest image ==="
            sudo docker pull devyoon2199/team119app:latest
            
            # í™˜ê²½ë³€ìˆ˜ í™•ì¸
            echo "=== Environment Variables Check ==="
            echo "SPRING_PROFILES_ACTIVE will be: prod"
            
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ìˆ˜ì •ëœ ì„¤ì •)
            echo "=== Starting new container ==="
            sudo docker run -d --name team119_was -p 8080:8080 \
              --restart unless-stopped \
              --health-cmd="curl -f http://localhost:8080/actuator/health || exit 1" \
              --health-interval=30s \
              --health-timeout=10s \
              --health-retries=3 \
              -e JAVA_TOOL_OPTIONS="-XX:+UnlockExperimentalVMOptions -XX:-UseContainerSupport" \
              -e SPRING_PROFILES_ACTIVE="prod" \
              -e JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}" \
              -e KAKAO_REST_KEY="${{ secrets.KAKAO_REST_KEY }}" \
              -e SEOUL_PUBLIC_DATA_API_KEY="${{ secrets.SEOUL_PUBLIC_DATA_API_KEY }}" \
              -e AWS_S3_BUCKET="${{ secrets.AWS_S3_BUCKET }}" \
              -e AWS_REGION="${{ secrets.AWS_REGION }}" \
              -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              devyoon2199/team119app:latest
            
            # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
            echo "=== Waiting for container startup ==="
            sleep 30
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "=== Container Status ==="
            if sudo docker ps | grep -q team119_was; then
              echo "âœ… Container is running"
              sudo docker ps | grep team119_was
            else
              echo "âŒ Container failed to start"
              sudo docker logs team119_was --tail 30
              exit 1
            fi
            
            # í™˜ê²½ë³€ìˆ˜ í™•ì¸
            echo "=== Environment Variables in Container ==="
            sudo docker exec team119_was printenv | grep -E "(SPRING_PROFILES_ACTIVE|DB_USERNAME)" || true
            
            # í—¬ìŠ¤ ì²´í¬
            echo "=== Health Check ==="
            HEALTH_SUCCESS=false
            for i in {1..8}; do
              echo "Health check attempt $i/8..."
              if timeout 15 curl -f http://localhost:8080/actuator/health; then
                echo "âœ… Application is healthy! (attempt $i)"
                HEALTH_SUCCESS=true
                break
              else
                echo "â³ Application not ready, checking logs..."
                sudo docker logs team119_was --tail 10 | grep -E "(ERROR|Exception)" || echo "No errors in recent logs"
                sleep 15
              fi
            done
            
            # ìµœì¢… ê²°ê³¼
            if [ "$HEALTH_SUCCESS" = true ]; then
              echo "ğŸ‰ Deployment completed successfully!"
            else
              echo "âŒ Deployment failed - Application not responding"
              echo "=== Full Container Logs ==="
              sudo docker logs team119_was --tail 50
              echo "=== Container Status ==="
              sudo docker ps -a | grep team119_was
              exit 1
            fi
